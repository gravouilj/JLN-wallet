import { useState, useEffect } from 'react';
import { Card, CardContent, Button, Input, Textarea, Select, InfoBox, Stack } from '../UI';
import { createTicket } from '../../services/ticketService';
import { useTranslation } from '../../hooks';

/**
 * ClientTicketForm - Formulaire de cr√©ation de ticket pour les clients (REFACTORIS√â)
 * 
 * Nouvelles fonctionnalit√©s Phase 2:
 * - autoContext: D√©tection automatique du contexte (tokenId, profileId)
 * - allowTypeSelection: Permet de choisir entre Admin/Cr√©ateur
 * - allowTokenSelection: Permet de choisir un token parmi availableTokens
 * - Cat√©gories contextuelles selon le type
 * - FAQ int√©gr√©e par cat√©gorie
 * 
 * @param {Object} props
 * @param {Object} [props.autoContext] - Contexte auto-d√©tect√© { tokenId, creatorProfileId, tokenInfo }
 * @param {boolean} [props.allowTypeSelection=false] - Permet de choisir Admin ou Cr√©ateur
 * @param {boolean} [props.allowTokenSelection=false] - Permet de choisir un token
 * @param {Array} [props.availableTokens=[]] - Liste des tokens pour s√©lection
 * @param {String} props.walletAddress - Adresse du wallet client
 * @param {Function} props.onSubmit - Callback apr√®s soumission r√©ussie
 * @param {Function} props.onCancel - Callback pour annuler
 */
const ClientTicketForm = ({ 
  autoContext = null,
  allowTypeSelection = false,
  allowTokenSelection = false,
  availableTokens = [],
  walletAddress,
  onSubmit,
  onCancel,
  setNotification
}) => {
  const { t } = useTranslation();
  // D√©tecter le type initial selon autoContext
  const initialType = autoContext?.creatorProfileId ? 'creator' : 'admin';
  
  const [ticketType, setTicketType] = useState(initialType);
  const [selectedTokenId, setSelectedTokenId] = useState(autoContext?.tokenId || null);
  const [selectedProfileId, setSelectedProfileId] = useState(autoContext?.creatorProfileId || null);
  
  const [formData, setFormData] = useState({
    subject: '',
    category: 'question',
    priority: 'normal',
    description: ''
  });
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState('');

  // Update context when autoContext changes
  useEffect(() => {
    if (autoContext) {
      if (autoContext.tokenId) setSelectedTokenId(autoContext.tokenId);
      if (autoContext.creatorProfileId) setSelectedProfileId(autoContext.creatorProfileId);
      if (autoContext.creatorProfileId && !allowTypeSelection) {
        setTicketType('creator');
      }
    }
  }, [autoContext, allowTypeSelection]);

  // Cat√©gories selon le type (contextuelles)
  const categories = ticketType === 'admin' 
    ? [
        { value: 'question', label: '‚ùì Question g√©n√©rale' },
        { value: 'bug', label: 'üêõ Signaler un bug' },
        { value: 'feature', label: '‚ú® Demande de fonctionnalit√©' },
        { value: 'payment', label: 'üí≥ Probl√®me de paiement' },
        { value: 'account', label: 'üë§ Probl√®me de compte' },
      ]
    : [
        { value: 'question', label: '‚ùì Question sur le token' },
        { value: 'support', label: 'üÜò Demande de support' },
        { value: 'order', label: 'üì¶ Commande / Livraison' },
        { value: 'report', label: '‚ö†Ô∏è Signaler un probl√®me' },
        { value: 'partnership', label: 'ü§ù Proposition de partenariat' },
      ];

  const priorities = [
    { value: 'low', label: 'üü¢ Basse' },
    { value: 'normal', label: 'üü° Normale' },
    { value: 'high', label: 'üü† Haute' },
    { value: 'urgent', label: 'üî¥ Urgente' },
  ];

  const handleChange = (field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
    setError('');
  };icketType === 'creator' && !selectedTokenId && !selectedProfileId) {
      setError('Vous devez s√©lectionner un token ou un cr√©ateur');
      return false;
    }
    if (!walletAddress) {
      setError('Adresse wallet manquante
  const validateForm = () => {
    if (!formData.subject.trim()) {
      setError('Le sujet est requis');
      return false;
    }
    if (formData.subject.trim().length < 5) {
      setError('Le sujet doit contenir au moins 5 caract√®res');
      return false;
    }
    if (!formData.description.trim()) {
      setError('La description est requise');
      return false;
    }
    if (formData.description.trim().length < 20) {
      setError('La description doit contenir au moins 20 caract√®res');
      return false;
    }
    if (type === 'creator' && !tokenId) {
      setError('Token ID manquant');
      return false;
    }
    return true;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!validateForm()) return;

    setSub√©terminer le type de ticket selon le nouveau sch√©ma
      const ticketTypeEnum = ticketType === 'admin' ? 'admin_client' : 'creator_client';

      // M√©tadonn√©es avec contexte enrichi
      const metadata = {};
      if (autoContext?.tokenInfo) {
        metadata.tokenInfo = autoContext.tokenInfo;
      }

      // Donn√©es du ticket selon le nouveau sch√©ma tickets_refactoring.sql
      const ticketData = {
        subject: formData.subject.trim(),
        description: formData.description.trim(),
        type: ticketTypeEnum,
        category: formData.category,
        priority: formData.priority,
        created_by_address: walletAddress,
        created_by_role: 'client',
        token_id: selectedTokenId,
        creator_profile_id: selectedProfileId,
        client_address: walletAddress,
        metadata
      };

      // Cr√©er le ticket via service
      const ticket = await createTicket(ticketData);

      // Notification de succ√®s
      if (setNotification) {
        setNotification({
          type: 'success',
          message: ticketType === 'creator' 
            ? '‚úÖ Message envoy√© au cr√©ateur avec succ√®s !' 
            : '‚úÖ Ticket cr√©√© avec succ√®s ! Notre √©quipe vous r√©pondra bient√¥t.'
        });
      }

      // R√©initialiser le formulaire
      setFormData({
        subject: '',
        category: 'question',
        priority: 'normal',
        description: ''
      });

      // Ne reset pas les s√©lections si autoContext fourni
      if (!autoContext) {
        setSelectedTokenId(null);
        setSelectedProfileId(null);
      }

      // Callback de succ√®s
      if (onSubmit) {
        onSubmit(ticket);
      }

    } catch (err) {
      console.error('‚ùå Erreur cr√©ation ticket:', err);
      const errorMessage = err.message || 'Erreur lors de la cr√©ation du ticket';
      setError(errorMessage);
      
      if (setNotification) {
        setNotification({
          type: 'error',
          message: `‚ùå ${errorMessage}`
      if (setNotification) {
        setNotification({
          type: 'error',
          message: errorMessage
        });
      }
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <Card>
      <CardContent className="p-6">
        <h2 className="text-xl font-bold mb-4" style={{ color: 'var(--text-primary)' }}>
          {ticketType === 'admin' ? 'üìß Contacter le support' : 'üí¨ Contacter le cr√©ateur'}
        </h2>

        {/* S√©lecteur de type (Admin ou Cr√©ateur) */}
        {allowTypeSelection && (
          <div style={{ marginBottom: '16px' }}>
            <label style={{
              display: 'block',
              fontSize: '0.9rem',
              fontWeight: '600',
              marginBottom: '8px',
              color: 'var(--text-primary)'
            }}>
              üéØ Destinataire
            </label>
            <div style={{ display: 'flex', gap: '8px' }}>
              <Button
                variant={ticketType === 'admin' ? 'primary' : 'outline'}
                onClick={() => setTicketType('admin')}
                style={{ flex: 1 }}
              >
                üë®‚Äçüíº Admin
              </Button>
              <Button
                variant={ticketType === 'creator' ? 'primary' : 'outline'}
                onClick={() => setTicketType('creator')}
                style={{ flex: 1 }}
              >
                üåæ Cr√©ateur
              </Button>
            </div>
          </div>
        )}

        {/* S√©lecteur de token */}
        {allowTokenSelection && ticketType === 'creator' && availableTokens.length > 0 && (
          <Select
            label="üé´ Token concern√©"
            value={selectedTokenId || ''}
            onChange={(e) => {
              const tokenId = e.target.value;
              setSelectedTokenId(tokenId);
              // Trouver le profil du cr√©ateur
              const token = availableTokens.find(t => t.tokenId === tokenId);
              if (token?.creatorProfileId) {
                setSelectedProfileId(token.creatorProfileId);
              }
            }}
            options={[
              { value: '', label: '-- S√©lectionner un token --' },
              ...availableTokens.map(token => ({
                value: token.tokenId,
                label: `${token.ticker} - ${token.name}`
              }))
            ]}
          />
        )}

        {/* Info contextuelle */}
        {ticketType === 'creator' && autoContext?.tokenInfo && (
          <InfoBox type="info" icon="üí°" className="mb-4">
            Votre message concerne <strong>{autoContext.tokenInfo.ticker}</strong> et sera envoy√© directement au cr√©ateur.
          </InfoBox>
        )}

        {ticketType === 'creator' && !autoContext && (
          <InfoBox type="info" icon="üí°" className="mb-4">
            Votre message sera envoy√© directement au cr√©ateur du token s√©lectionn√©. 
            Il recevra une notification et pourra vous r√©pondre rapidement.
          </InfoBox>
        )}

        <form onSubmit={handleSubmit}>
          <Stack spacing="md">
            {/* Sujet */}
            <Input
              label="üìù Sujet"
              value={formData.subject}
              onChange={(e) => handleChange('subject', e.target.value)}
              placeholder="R√©sumez votre demande en quelques mots"
              required
              maxLength={100}
            />

            {/* Cat√©gorie */}
            <Select
              label="üìÇ Cat√©gorie"
              value={formData.category}
              onChange={(e) => handleChange('category', e.target.value)}
              options={categories}
            />

            {/* Priorit√© */}
            <Select
              label="‚ö° Priorit√©"
              value={formData.priority}
              onChange={(e) => handleChange('priority', e.target.value)}
              options={priorities}
            />

            {/* Description */}
            <Textarea
              label="üìÑ Description d√©taill√©e"
              value={formData.description}
              onChange={(e) => handleChange('description', e.target.value)}
              placeholder="D√©crivez votre demande en d√©tail..."
              rows={6}
              required
              maxLength={2000}
            />

            <div className="text-sm text-secondary">
              {formData.description.length}/2000 caract√®res
            </div>

            {/* Erreur */}
            {error && (
              <InfoBox type="error" icon="‚ùå">
                {error}
              </InfoBox>
            )}

            {/* Info temps de r√©ponse */}
            <InfoBox type="info" icon="‚è±Ô∏è">
              <strong>Temps de r√©ponse estim√© :</strong>
              <ul className="mb-0 mt-1" style={{ paddingLeft: '1.5rem' }}>
                <li>Urgente : sous 4 heures</li>
                <li>Haute : sous 24 heures</li>
                <li>Normale : 1-2 jours ouvr√©s</li>
                <li>Basse : 3-5 jours ouvr√©s</li>
              </ul>
            </InfoBox>

            {/* Boutons */}
            <div className="d-flex gap-2">
              {onCancel && (
                <Button
                  type="button"
                  variant="outline"
                  onClick={onCancel}
                  className="flex-1"
                  disabled={submitting}
                >
                  Annuler
                </Button>
              )}
              <Button
                type="submit"
                variant="primary"
                disabled={submitting || !formData.subject.trim() || !formData.description.trim()}
                className="flex-1"
              >
                {submitting ? 'Envoi...' : 'üì§ Envoyer'}
              </Button>
            </div>
          </Stack>
        </form>
      </CardContent>
    </Card>
  );
};

export default ClientTicketForm;
